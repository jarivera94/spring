{
    "nombre":"facturacion",
    "cabecera":"estado_actual;fecha_enviado;fecha_estado;creador_nombres;creador_apellidos;creador_rol;tipo_avaluo;id_sisgen;codigo_externo;fecha_creacion;entidad_nombre;tipo_credito;tipo_documento_identificacion_cliente;identificacion_cliente;cliente_nombre_completo;perito_nombres_apellidos;valor_total_avaluo;tarifa;honorarios;estado_construccion;direccion_inmueble_informe;ciudad_inmueble;matricula_inmobiliaria_principal_1;correo_abogado;nombre_abogado;fecha_visita;nombres_ultimo_usuario;apellidos_ultimo_usuario;tipo_de_inmueble;clase_inmueble",
    "consulta":"SELECT CONCAT_WS(';', estado.nombre, COALESCE(to_char(estE.fecha_estado,'yyyy-mm-dd HH24:MI:SS'), to_char(estCo.fecha_estado,'yyyy-mm-dd HH24:MI:SS'), ''), to_char(estA.fecha_estado,'yyyy-mm-dd HH24:MI:SS'), CONCAT('\"', COALESCE(uCreador.nombres, ''), '\"'), CONCAT('\"', COALESCE(uCreador.apellidos, ''), '\"'), r.nombre, ta.nombre, CONCAT('\"', COALESCE(a.avaluo_sisgen_id, null), '\"'), a.codigo_externo, to_char(a.fecha_creacion,'yyyy-mm-dd HH24:MI:SS'), ent.nombre, COALESCE(a.tipo_credito, ''), COALESCE(ti.nombre, ''), cliente.numero_documento, CASE WHEN cliente.tipo_documento_identificacion = 23 THEN CONCAT('\"', cliente.razon_social, '\"') ELSE CONCAT('\"', CONCAT_WS(' ', cliente.primer_nombre_solicitante, cliente.segundo_nombre_solicitante, cliente.primer_apellido_solicitante, cliente.segundo_apellido_solicitante), '\"') END, CONCAT('\"', CONCAT_WS(' ', uPerito.nombres, uPerito.apellidos), '\"'), COALESCE(round(a.valor_total_avaluo), 0), CASE WHEN a.tipo_credito = 'Vivienda' THEN t.tarifa ELSE 1.3000 END, CASE WHEN a.tipo_credito = 'Vivienda' AND round(a.valor_total_avaluo*t.tarifa/1000) <= t.valor_minimo THEN t.valor_minimo WHEN a.tipo_credito = 'Vivienda' AND round(a.valor_total_avaluo*t.tarifa/1000) > t.valor_minimo AND round(a.valor_total_avaluo*t.tarifa/1000) <= t.valor_maximo THEN round(a.valor_total_avaluo*t.tarifa/1000) WHEN a.tipo_credito = 'Vivienda' AND round(a.valor_total_avaluo*t.tarifa/1000) > t.valor_maximo THEN t.valor_maximo WHEN a.tipo_credito = 'Diferente de Vivienda' AND round(a.valor_total_avaluo*1.3000/1000) <= 193306 THEN 193306 WHEN a.tipo_credito = 'Diferente de Vivienda' AND round(a.valor_total_avaluo*1.3000/1000) > 193306 THEN round(a.valor_total_avaluo*1.3000/1000) ELSE 0 END, COALESCE(estC.nombre, ''), CONCAT('\"', COALESCE(REPLACE(a.direccion_inmueble_informe,';',','), ''), '\"'), CONCAT('\"', COALESCE(NULLIF(ciudad_informe.centro_poblado, ''), ciudad_solicitud.centro_poblado), '\"'), CONCAT('\"', COALESCE(a.matricula_inmobiliaria_principal_1, ''), '\"'), CASE WHEN a.tipo_avaluo = '6' THEN CONCAT('\"', COALESCE(uCreador.email, ''), '\"') ELSE '\"\"' END, CASE WHEN a.tipo_avaluo = '6' THEN CONCAT('\"', COALESCE(CONCAT_WS(' ', uCreador.nombres, uCreador.apellidos), ''), '\"') ELSE '\"\"' END, CONCAT('\"', COALESCE(to_char(ev.fecha_hora_inicio, 'yyyy-mm-dd HH24:MI:SS'), ''), '\"'), uAprobador.nombres, uAprobador.apellidos, tin.nombre, ci.nombre) FROM avaluos.avaluo a LEFT JOIN avaluos.usuario uCreador ON (uCreador.tipo_documento_identificacion = a.creador_tipo_documento) AND (uCreador.numero_documento = a.creador_numero_documento) LEFT JOIN avaluos.rol r ON (r.rol_id = uCreador.rol_id) LEFT JOIN avaluos.tipo_avaluo ta ON (ta.tipo_avaluo_id = a.tipo_avaluo) LEFT JOIN avaluos.entidad ent ON (ent.entidad_id = a.entidad_id) LEFT JOIN avaluos.formato_informe fi ON (fi.avaluo_id = a.avaluo_id) LEFT JOIN avaluos.formato_informe_hipotecario fih ON (fih.formato_informe_id = fi.formato_informe_id) LEFT JOIN avaluos.cliente cliente ON (cliente.tipo_documento_identificacion = a.cliente_tipo_documento) AND (cliente.numero_documento = a.cliente_numero_documento) LEFT JOIN avaluos.tipo_identificacion ti ON (ti.id = cliente.tipo_documento_identificacion)LEFT JOIN avaluos.divipola divCl ON (divCl.divipola_id = cliente.divipola) LEFT JOIN avaluos.divipola ciudad_solicitud ON (ciudad_solicitud.divipola_id = a.divipola) LEFT JOIN avaluos.divipola ciudad_informe ON (ciudad_informe.divipola_id = a.divipola_informe) LEFT JOIN avaluos.estado_avaluo estA ON (estA.avaluo_id = a.avaluo_id) AND (estA.estado_actual = true)JOIN avaluos.estado estado ON (estado.estado_id = estA.estado) LEFT JOIN (SELECT avaluo_id, estado, MAX(fecha_estado) fecha_estado FROM avaluos.estado_avaluo GROUP BY estado, avaluo_id) estE ON (estE.avaluo_id = a.avaluo_id AND estE.estado = 8)LEFT JOIN (SELECT avaluo_id, estado, MAX(fecha_estado) fecha_estado FROM avaluos.estado_avaluo GROUP BY estado, avaluo_id) estCo ON (estCo.avaluo_id = a.avaluo_id AND estCo.estado = 10) LEFT JOIN avaluos.usuario uPerito ON (uPerito.tipo_documento_identificacion = estA.tipo_documento_perito) AND (uPerito.numero_documento = estA.numero_documento_perito) LEFT JOIN avaluos.usuario uAprobador ON (uAprobador.tipo_documento_identificacion = estA.tipo_documento_usuario) AND (uAprobador.numero_documento = estA.numero_documento_usuario) LEFT JOIN avaluos.estado_construccion estC ON (estC.id = fih.estado_de_construccion) LEFT JOIN avaluos.tarifa t ON (t.entidad_id = ent.entidad_id AND t.tipo_avaluo_id = ta.tipo_avaluo_id) LEFT JOIN avaluos.evento ev ON a.avaluo_id = ev.avaluo_id LEFT JOIN avaluos.tipo_inmueble tin ON a.tipo_de_inmueble = tin.id LEFT JOIN avaluos.clase_inmueble ci ON (fih.clase_inmueble = ci.id) WHERE estA.fecha_estado BETWEEN :fechaInicialInforme AND :fechaFinalInforme ORDER BY ent.nombre, ta.nombre , a.tipo_credito",
    "extension":"csv",
    "mapeo":["estado.estado","fechaEnviado","fechaEstado","creador.nombres","creador.apellidos","creador.rol.nombre","tipoAvaluo.nombre","avaluoSisgenId","codigoExterno","fechaCreacion","entidad.nombre","tipoCredito","cliente.tipoDocumentoIdentificacion","cliente.numeroDocumento","cliente.primerNombre","cliente.segundoNombre","cliente.primerApellido","cliente.segundoApellido","perito.nombres","perito.apellidos","valorTotalAvaluo","tarifa.tarifa","valorHonorarios","estadoDeConstruccion","direccionInmuebleInforme","divipolaInforme.centroPoblado","matriculaInmobiliariaPrincipal1","creador.email","creador.nombres","creador.apellidos","evento.fechaHoraInicio","estado.avaluo.nombres","estado.avaluo.apellidos"],
    "procesadoresCsv":["NotNull","OptionalFmtDate","FmtDate","NotNull","NotNull","NotNull","NotNull","NotNull","NotNull","FmtDate","NotNull","Optional","TipoDocumento","NotNull","Optional","Optional","Optional","Optional","Optional","Optional","OptionalFmtNumber","FmtNumber","OptionalFmtNumber","EstadoConstruccion","Optional","Optional","Optional","NotNull","NotNull","NotNull","NotNull","NotNull"]
}
